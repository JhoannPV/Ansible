---
- name: Preparar nodos (workers) para SonarQube
  hosts: workers
  become: true
  tasks:
    - name: Asegurar vm.max_map_count=262144 (persistente)
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        regexp: '^vm.max_map_count='
        line: 'vm.max_map_count=262144'
        state: present

    - name: Aplicar vm.max_map_count inmediatamente
      ansible.builtin.command: sysctl -w vm.max_map_count=262144
      changed_when: false

- name: Desplegar SonarQube Community en MicroK8s via Helm
  hosts: controller
  connection: local
  become: true
  vars_files:
    - ../vars/env.yml

  vars:
    SONARQUBE_NAMESPACE: "{{ K8S_NAMESPACE | default('calendar-app') }}"
    SONARQUBE_IMAGE: "sonarqube:9.9-community"
    SONARQUBE_HELM_RELEASE: "sonarqube"
    SONARQUBE_STORAGE_SIZE: "8Gi"
    SONARQUBE_HOST: "{{ SONARQUBE_HOST | default('sonar.local') }}"
    helm_values_path: "/tmp/sonarqube-values.yaml"
    monitoring_passcode_length: 16

  tasks:
    - name: Validar variables requeridas
      ansible.builtin.assert:
        that:
          - SONARQUBE_NAMESPACE is defined
          - SONARQUBE_HOST is defined
        fail_msg: "Faltan SONARQUBE_NAMESPACE o SONARQUBE_HOST (añade SONARQUBE_HOST en vars/env.yml)."

    - name: Generar monitoringPasscode aleatorio
      ansible.builtin.set_fact:
        monitoring_passcode: "{{ lookup('ansible.builtin.password', '/dev/null chars=ascii_letters,digits length=' + monitoring_passcode_length|string) }}"

    - name: Habilitar addons necesarios (helm3, storage, ingress)
      ansible.builtin.command: "microk8s enable helm3 storage ingress"
      register: addons_enable
      changed_when: "'enabled' in addons_enable.stdout or addons_enable.rc == 0"
      failed_when: false

    - name: Asegurar vm.max_map_count en el host (requisito Elasticsearch)
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        regexp: '^vm.max_map_count='
        line: 'vm.max_map_count=262144'
        state: present
      notify: Reload sysctl

    - name: Aplicar vm.max_map_count inmediato
      ansible.builtin.command: sysctl -w vm.max_map_count=262144
      changed_when: false

    - name: Crear namespace SonarQube si no existe
      ansible.builtin.command: "microk8s kubectl create ns {{ SONARQUBE_NAMESPACE }}"
      register: ns_create
      changed_when: ns_create.rc == 0
      failed_when: false

    - name: Añadir repo Helm SonarQube
      ansible.builtin.command: "microk8s helm3 repo add sonarqube https://SonarSource.github.io/helm-chart-sonarqube"
      register: helm_repo_add
      changed_when: helm_repo_add.rc == 0
      failed_when: false

    - name: Actualizar repos Helm
      ansible.builtin.command: "microk8s helm3 repo update"
      changed_when: false

    - name: Renderizar archivo de valores Helm
      ansible.builtin.copy:
        dest: "{{ helm_values_path }}"
        mode: '0644'
        content: |
          image:
            repository: {{ SONARQUBE_IMAGE.split(':')[0] }}
            tag: {{ SONARQUBE_IMAGE.split(':')[1] | default('latest') }}
          community:
            enabled: true
          monitoringPasscode: {{ monitoring_passcode }}
          persistence:
            enabled: true
            storageClass: microk8s-hostpath
            size: {{ SONARQUBE_STORAGE_SIZE }}
          # Seguridad del pod para acceso a volúmenes hostpath en MicroK8s
          securityContext:
            fsGroup: 1000
            fsGroupChangePolicy: OnRootMismatch
            runAsUser: 1000
            runAsGroup: 1000
          ingress:
            enabled: true
            hosts:
              - name: {{ SONARQUBE_HOST }}
                path: /
            annotations:
              kubernetes.io/ingress.class: public
            ingressClassName: public
            tls: []
          # Ajuste de probes (usando claves soportadas por el chart)
          startupProbe:
            enabled: true
            initialDelaySeconds: 90
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 120
          readinessProbe:
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 20
          livenessProbe:
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 10
          resources:
            limits:
              cpu: "1"
              memory: "2Gi"
            requests:
              cpu: "500m"
              memory: "1Gi"
          # Ajustar Java opts para entornos pequeños
          sonarProperties:
            sonar.ce.javaOpts: "-Xms384m -Xmx384m -XX:+HeapDumpOnOutOfMemoryError"
            sonar.web.javaOpts: "-Xms512m -Xmx512m -XX:+HeapDumpOnOutOfMemoryError"
            sonar.search.javaOpts: "-Xms512m -Xmx512m -XX:+HeapDumpOnOutOfMemoryError"

    - name: Instalar/Actualizar release SonarQube
      ansible.builtin.command: >-
        microk8s helm3 upgrade --install {{ SONARQUBE_HELM_RELEASE }} sonarqube/sonarqube
        --namespace {{ SONARQUBE_NAMESPACE }}
        -f {{ helm_values_path }}
      register: helm_install
      changed_when: "'Release' in helm_install.stdout or helm_install.rc == 0"
      failed_when: helm_install.rc != 0

    - name: Esperar a que el StatefulSet de SonarQube esté listo (hasta 15 min)
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} rollout status statefulset/{{ SONARQUBE_HELM_RELEASE }}-sonarqube --timeout=900s
      register: rollout_sq
      retries: 1
      delay: 5
      failed_when: false
      changed_when: false

    - name: Obtener describe del StatefulSet (debug)
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} describe statefulset {{ SONARQUBE_HELM_RELEASE }}-sonarqube
      register: sts_describe
      changed_when: false
      when: rollout_sq.rc != 0

    - name: Listar pods SonarQube (debug)
      ansible.builtin.command: "microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} get pods -l app=sonarqube -o wide"
      register: sq_pods_list
      changed_when: false
      when: rollout_sq.rc != 0

    - name: Obtener nombre del primer pod SonarQube (si existe)
      ansible.builtin.command:
        argv:
          - microk8s
          - kubectl
          - -n
          - "{{ SONARQUBE_NAMESPACE }}"
          - get
          - pods
          - -l
          - app=sonarqube
          - -o
          - "jsonpath={.items[0].metadata.name}"
      register: first_pod_name
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0

    - name: Describe del pod SonarQube (debug)
      ansible.builtin.command:
        argv:
          - microk8s
          - kubectl
          - -n
          - "{{ SONARQUBE_NAMESPACE }}"
          - describe
          - pod
          - "{{ first_pod_name.stdout | default('') }}"
      register: pod_describe
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0 and (first_pod_name.stdout is defined and first_pod_name.stdout | length > 0)

    - name: Logs contenedor principal (tail 200)
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} logs -l app=sonarqube -c sonarqube --tail=200
      register: pod_logs
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0

    - name: Logs previos del contenedor principal (si existen)
        
      ansible.builtin.command:
        argv:
          - microk8s
          - kubectl
          - -n
          - "{{ SONARQUBE_NAMESPACE }}"
          - logs
          - "{{ first_pod_name.stdout | default('') }}"
          - -c
          - sonarqube
          - --previous
          - --tail=1000
      register: pod_logs_prev
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0 and (first_pod_name.stdout is defined and first_pod_name.stdout | length > 0)

    - name: Contenido de /opt/sonarqube/logs dentro del pod (si está en ejecución)
      ansible.builtin.command:
        argv:
          - microk8s
          - kubectl
          - -n
          - "{{ SONARQUBE_NAMESPACE }}"
          - exec
          - "{{ first_pod_name.stdout | default('') }}"
          - --
          - sh
          - -lc
          - |
            for f in /opt/sonarqube/logs/*.log; do echo "===== $f ====="; tail -n +1 "$f" || true; done
      register: pod_file_logs
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0 and (first_pod_name.stdout is defined and first_pod_name.stdout | length > 0)

    - name: Detalle PVC y PV de SonarQube
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} get pvc sonarqube-sonarqube -o yaml
      register: pvc_detail
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0

    - name: Estado Postgres (pods)
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} get pods -l app.kubernetes.io/name=postgresql -o wide
      register: pg_pods
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0

    - name: Logs Postgres (tail 200)
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} logs statefulset/sonarqube-postgresql --tail=200
      register: pg_logs
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0

    - name: Eventos recientes relacionados (debug)
      ansible.builtin.shell: "microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} get events --sort-by=.lastTimestamp | grep -i -E 'sonar|elastic|java|oom' || true"
      args:
        executable: /bin/bash
      register: sq_events
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0

    - name: Mostrar diagnóstico de fallo rollout
      ansible.builtin.debug:
        msg:
          - "Rollout SonarQube falló. Revisa la información de diagnóstico."
          - "StatefulSet describe:" 
          - "{{ sts_describe.stdout | default('No STS describe') }}"
          - "Pods list:" 
          - "{{ sq_pods_list.stdout | default('No pods list') }}"
          - "Pod describe:" 
          - "{{ pod_describe.stdout | default('No pod describe') }}"
          - "Logs (tail 200):" 
          - "{{ pod_logs.stdout | default('No logs') }}"
          - "Logs previos (si hay):"
          - "{{ pod_logs_prev.stdout | default('No previous logs') }}"
          - "Logs en archivos dentro del contenedor:"
          - "{{ pod_file_logs.stdout | default('No file logs') }}"
          - "PVC detalle:"
          - "{{ pvc_detail.stdout | default('No pvc detail') }}"
          - "Postgres pods:"
          - "{{ pg_pods.stdout | default('No pg pods') }}"
          - "Postgres logs (tail 200):"
          - "{{ pg_logs.stdout | default('No pg logs') }}"
          - "Eventos:" 
          - "{{ sq_events.stdout | default('No events') }}"
      when: rollout_sq.rc != 0

    # Remediación automática: crear usuario/DB en Postgres y reintentar rollout
    - name: Obtener nombre del pod de Postgres
      ansible.builtin.command:
        argv:
          - microk8s
          - kubectl
          - -n
          - "{{ SONARQUBE_NAMESPACE }}"
          - get
          - pods
          - -l
          - app.kubernetes.io/name=postgresql,app.kubernetes.io/instance={{ SONARQUBE_HELM_RELEASE }}
          - -o
          - "jsonpath={.items[0].metadata.name}"
      register: pg_pod_name
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0

    - name: Obtener secreto de Postgres (json)
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} get secret {{ SONARQUBE_HELM_RELEASE }}-postgresql -o json
      register: pg_secret_json
      changed_when: false
      failed_when: false
      when: rollout_sq.rc != 0

    - name: Decodificar contraseñas de BD desde el secreto
      ansible.builtin.set_fact:
        sq_app_password_b64: "{{ (pg_secret_json.stdout | default('{}')) | from_json | json_query('data."postgresql-password"') | default('') }}"
        pg_admin_password_b64: "{{ (pg_secret_json.stdout | default('{}')) | from_json | json_query('data."postgres-password"') | default('') }}"
      when: rollout_sq.rc != 0

    - name: Establecer contraseñas decodificadas
      ansible.builtin.set_fact:
        sq_app_password: "{{ sq_app_password_b64 | b64decode if sq_app_password_b64 | length > 0 else '' }}"
        pg_admin_password: "{{ pg_admin_password_b64 | b64decode if pg_admin_password_b64 | length > 0 else '' }}"
      when: rollout_sq.rc != 0

    - name: Crear/actualizar rol sonarUser y BD sonarDB en Postgres (si hay credenciales)
      ansible.builtin.shell: |
        set -euo pipefail
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} exec {{ pg_pod_name.stdout }} -- bash -lc '
          export PGPASSWORD="{{ pg_admin_password }}";
          psql -U postgres -d postgres -v ON_ERROR_STOP=1 -c "CREATE ROLE \"sonarUser\" LOGIN PASSWORD '{{ sq_app_password }}';" 2>/dev/null || true;
          psql -U postgres -d postgres -v ON_ERROR_STOP=1 -c "ALTER ROLE \"sonarUser\" WITH LOGIN PASSWORD '{{ sq_app_password }}';";
          psql -U postgres -d postgres -v ON_ERROR_STOP=1 -c "CREATE DATABASE \"sonarDB\" OWNER \"sonarUser\";" 2>/dev/null || true;
          psql -U postgres -d postgres -v ON_ERROR_STOP=1 -c "GRANT ALL PRIVILEGES ON DATABASE \"sonarDB\" TO \"sonarUser\";" 2>/dev/null || true;
        '
      args:
        executable: /bin/bash
      register: pg_fix
      changed_when: true
      failed_when: false
      when: rollout_sq.rc != 0 and (pg_pod_name.stdout | default('')) | length > 0 and (pg_admin_password | default('')) | length > 0 and (sq_app_password | default('')) | length > 0

    - name: Reiniciar pod de SonarQube para reintentar conexión a Postgres
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} delete pod {{ first_pod_name.stdout }} --ignore-not-found
      register: restart_sq_pod
      changed_when: true
      failed_when: false
      when: rollout_sq.rc != 0 and (first_pod_name.stdout | default('')) | length > 0

    - name: Esperar nuevamente a que el StatefulSet esté listo tras remediación (10 min)
      ansible.builtin.command: >-
        microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} rollout status statefulset/{{ SONARQUBE_HELM_RELEASE }}-sonarqube --timeout=600s
      register: rollout_sq_retry
      failed_when: false
      changed_when: false
      when: rollout_sq.rc != 0

    - name: Mostrar resultado post-remediación
      ansible.builtin.debug:
        msg:
          - "Resultado del fix Postgres: rc={{ pg_fix.rc | default('n/a') }}"
          - "Rollout retry rc={{ rollout_sq_retry.rc | default('n/a') }}"
      when: rollout_sq.rc != 0

    - name: Fallar explícitamente si rollout no fue exitoso
      ansible.builtin.fail:
        msg: "SonarQube no llegó a Ready. Ver diagnóstico anterior y ajustar recursos/JVM/almacenamiento."
      when: rollout_sq.rc != 0 and (rollout_sq_retry.rc | default(1)) != 0

    - name: Mostrar Ingress creado
      ansible.builtin.command: "microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} get ingress"
      register: sq_ing
      changed_when: false

    - name: Instrucciones de acceso
      ansible.builtin.debug:
        msg:
          - "Añade en tu PC /etc/hosts: <IP_DEL_NODO>  {{ SONARQUBE_HOST }}"
          - "Accede a: http://{{ SONARQUBE_HOST }}"
          - "Credenciales iniciales: admin / admin"
          - "Genera token: Admin -> My Account -> Security -> Generate Token"
          - "Usa ese token en Azure DevOps Service Connection 'SonarQube-Service'"

  handlers:
    - name: Reload sysctl
      ansible.builtin.command: sysctl -p
      changed_when: false

- name: Limpieza opcional SonarQube (Helm + PVC)
  hosts: controller
  connection: local
  become: true
  vars_files:
    - ../vars/env.yml
  vars:
    SONARQUBE_NAMESPACE: "{{ K8S_NAMESPACE | default('calendar-app') }}"
    SONARQUBE_HELM_RELEASE: "sonarqube"
  tasks:
    - name: Desinstalar release Helm SonarQube
      ansible.builtin.command: "microk8s helm3 uninstall {{ SONARQUBE_HELM_RELEASE }} -n {{ SONARQUBE_NAMESPACE }}"
      ignore_errors: true
      tags: [cleanup]

    - name: Eliminar PVC de SonarQube
      ansible.builtin.command: "microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} delete pvc -l app=sonarqube --ignore-not-found"
      ignore_errors: true
      tags: [cleanup]

    - name: Eliminar PVC de Postgres (restablecer credenciales BD)
      ansible.builtin.command: "microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} delete pvc -l app.kubernetes.io/name=postgresql,app.kubernetes.io/instance={{ SONARQUBE_HELM_RELEASE }} --ignore-not-found"
      ignore_errors: true
      tags: [cleanup]

    - name: Eliminar Ingress SonarQube
      ansible.builtin.command: "microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} delete ingress -l app=sonarqube --ignore-not-found"
      ignore_errors: true
      tags: [cleanup]

    - name: Eliminar eventos antiguos
      ansible.builtin.command: "microk8s kubectl -n {{ SONARQUBE_NAMESPACE }} delete events --all"
      ignore_errors: true
      tags: [cleanup]

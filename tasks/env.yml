# Load env vars, validate and render .env
- name: Check if vars/env.yml exists
  ansible.builtin.stat:
    path: vars/env.yml
  register: env_file_stat

- name: Load vars from vars/env.yml
  ansible.builtin.include_vars:
    file: vars/env.yml
  when: env_file_stat.stat.exists

- name: Ensure vars/env.yml exists
  ansible.builtin.assert:
    that:
      - env_file_stat.stat.exists
    fail_msg: "No se encontraron variables. Copia vars/env.yml.template a vars/env.yml y completa los valores."
    quiet: true

- name: Validate required env vars are present
  ansible.builtin.assert:
    that:
      - MONGO_INITDB_USERNAME is defined and (MONGO_INITDB_USERNAME | length) > 0
      - MONGO_INITDB_PASSWORD is defined and (MONGO_INITDB_PASSWORD | length) > 0
      - MONGO_URL is defined and (MONGO_URL | length) > 0
      - MONGO_DB_NAME is defined and (MONGO_DB_NAME | length) > 0
      - JWT_SEED is defined and (JWT_SEED | length) > 0
      - VITE_API_URL is defined and (VITE_API_URL | length) > 0
    fail_msg: "Faltan variables requeridas para generar .env (MONGO_INITDB_USERNAME, MONGO_INITDB_PASSWORD, MONGO_URL, MONGO_DB_NAME, JWT_SEED, VITE_API_URL). Completa vars/env.yml"
    quiet: true

- name: Render .env from template
  ansible.builtin.template:
    src: templates/dotenv.j2
    dest: "{{ project_path }}/.env"
    owner: sysadmin
    group: sysadmin
    mode: '0600'
  no_log: true
  become_user: sysadmin

---
- name: Exponer SonarQube vÃ­a Ingress en MicroK8s
  hosts: controller
  gather_facts: false

  vars_files:
    - vars/sonarqube.yml

  pre_tasks:
    - name: Validar variables requeridas para Ingress
      ansible.builtin.assert:
        that:
          - SONAR_NAMESPACE is defined and SONAR_NAMESPACE | length > 0
          - SONAR_HOSTNAME is defined and SONAR_HOSTNAME | length > 0
        fail_msg: "Faltan variables SONAR_NAMESPACE o SONAR_HOSTNAME en vars/sonarqube.yml"

  tasks:
    - name: Render Ingress SonarQube
      ansible.builtin.template:
        src: templates/k8s/sonarqube-ingress.yaml.j2
        dest: "/tmp/sonarqube-k8s/30-ingress.yaml"

    - name: Aplicar Ingress SonarQube
      ansible.builtin.command: "microk8s kubectl apply -f /tmp/sonarqube-k8s/30-ingress.yaml"

    - name: Mostrar Ingress
      ansible.builtin.command: "microk8s kubectl -n {{ SONAR_NAMESPACE }} get ingress sonarqube -o wide"

---
- name: Exponer SonarQube (Docker en worker) vía Ingress de MicroK8s
  hosts: controller
  connection: local
  vars_files:
    - vars/env.yml

  vars:
    k8s_tmp_dir: "/tmp/sonarqube-docker-ingress"

  tasks:
    - name: Validar variables requeridas para Ingress
      ansible.builtin.assert:
        that:
          - K8S_NAMESPACE is defined
          - SONARQUBE_HOST is defined
          - SONARQUBE_PORT is defined
        fail_msg: "Faltan K8S_NAMESPACE, SONARQUBE_HOST o SONARQUBE_PORT en vars/env.yml"

    - name: Determinar IP del worker principal
      ansible.builtin.set_fact:
        sonarqube_target_ip: "{{ hostvars[groups['workers'][0]].ansible_host | default(groups['workers'][0]) }}"

    - name: Habilitar addon ingress en MicroK8s (idempotente)
      ansible.builtin.command: microk8s enable ingress
      become: true
      register: ingress_enable
      changed_when: ingress_enable.stdout is not search('Nothing to do for ingress')

    - name: Crear directorio temporal para manifests
      ansible.builtin.file:
        path: "{{ k8s_tmp_dir }}"
        state: directory
        mode: '0755'

    - name: Render Service externo para SonarQube (apunta al worker:{{ SONARQUBE_PORT }})
      ansible.builtin.template:
        src: templates/k8s/sonarqube-docker-service.yaml.j2
        dest: "{{ k8s_tmp_dir }}/10-sonarqube-docker-service.yaml"

    - name: Render Endpoints hacia el contenedor Docker en el worker
      ansible.builtin.template:
        src: templates/k8s/sonarqube-docker-endpoints.yaml.j2
        dest: "{{ k8s_tmp_dir }}/11-sonarqube-docker-endpoints.yaml"

    - name: Render Ingress para SonarQube Docker
      ansible.builtin.template:
        src: templates/k8s/sonarqube-ingress.yaml.j2
        dest: "{{ k8s_tmp_dir }}/20-sonarqube-ingress.yaml"

    - name: Aplicar Service, Endpoints e Ingress
      ansible.builtin.shell: |
        set -e
        microk8s kubectl -n {{ K8S_NAMESPACE }} apply -f {{ k8s_tmp_dir }}/10-sonarqube-docker-service.yaml
        microk8s kubectl -n {{ K8S_NAMESPACE }} apply -f {{ k8s_tmp_dir }}/11-sonarqube-docker-endpoints.yaml
        microk8s kubectl -n {{ K8S_NAMESPACE }} apply -f {{ k8s_tmp_dir }}/20-sonarqube-ingress.yaml
      args:
        executable: /bin/bash

    - name: Mostrar Ingress y Service
      ansible.builtin.command: "microk8s kubectl -n {{ K8S_NAMESPACE }} get ingress,svc sonarqube-docker-ingress sonarqube-docker-ext"
      register: out
      changed_when: false

    - name: Instrucciones de acceso
      ansible.builtin.debug:
        msg:
          - "Añade en tu PC: <IP_WORKER>  {{ SONARQUBE_HOST }}"
          - "Accede a: http://{{ SONARQUBE_HOST }}"
